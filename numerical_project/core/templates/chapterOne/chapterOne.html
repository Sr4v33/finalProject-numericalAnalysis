{% extends "core/base_template.html" %}
{% load static %}

{% block title %}Capítulo 1 - Solución de Ecuaciones{% endblock %}

{% block extra_head %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        try {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\(", right: "\\)", display: false},
                    {left: "\\[", right: "\\]", display: true}
                ],
                throwOnError: false // Para no detener todo si hay un error LaTeX
            });
        } catch (e) {
            console.error("Error al renderizar KaTeX:", e);
        }
    });
</script> 
<style>
    .parameter-field { display: none; } 
    .table-responsive { max-height: 1000px; }
    th { position: sticky; top: 0}
    .comparison-alert { display: none; }
    /* Ajuste para los botones de graficar */
    .input-group .btn {
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ page_title|default:"Capítulo 1: Sistemas de Ecuaciones No Lineales" }}</h1>
    <hr>

    <div class="row">
        <div class="col-md-5">
            <h2>Parámetros de Entrada</h2>

            <div class="mb-3 text-start">
                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="bi bi-question-circle-fill"></i> ¿Necesitas Ayuda?
                </button>
            </div>

            <form method="post" id="numericalMethodForm">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label for="id_function_f" class="form-label">Función f(x):</label>
                    <div class="input-group">
                        <input type="text" name="function_f" class="form-control" id="id_function_f" placeholder="Ej: x**3 - cos(x)" required value="{{ form.function_f.value|default_if_none:'' }}">
                        <button type="button" class="btn btn-outline-secondary" id="graphButton" style="display: none;">
                            <i class="bi bi-graph-up"></i> Graficar
                        </button>
                    </div>
                    <small class="form-text text-muted">Usa la sintaxis indicada en "¿Necesitas Ayuda?".</small>
                </div>

                <div class="mb-3 parameter-field" data-method="punto_fijo compare_all">
                    <label for="id_function_g" class="form-label">Función g(x):</label>
                     <div class="input-group">
                        <input type="text" name="function_g" class="form-control" id="id_function_g" placeholder="Ej: (cos(x))**(1/3)" value="{{ form.function_g.value|default_if_none:'' }}">
                        <button type="button" class="btn btn-outline-secondary" id="graphButton2" style="display: none;">
                            <i class="bi bi-graph-up"></i> Graficar
                        </button>
                    </div>
                    <small class="form-text text-muted">Necesario para Punto Fijo y ejecutar Comparación.</small>
                </div>

                <div class="mb-3">
                    <label for="id_method" class="form-label">Método:</label>
                    <select name="method" class="form-select" id="id_method" required>
                        <option value="">Selecciona un método...</option>
                        <option value="biseccion" {% if form.method.value == 'biseccion' %}selected{% endif %}>Bisección</option>
                        <option value="regla_falsa" {% if form.method.value == 'regla_falsa' %}selected{% endif %}>Regla Falsa</option>
                        <option value="punto_fijo" {% if form.method.value == 'punto_fijo' %}selected{% endif %}>Punto Fijo</option>
                        <option value="newton" {% if form.method.value == 'newton' %}selected{% endif %}>Newton</option>
                        <option value="secante" {% if form.method.value == 'secante' %}selected{% endif %}>Secante</option>
                        <option value="newton_modificado" {% if form.method.value == 'newton_modificado' %}selected{% endif %}>Newton Modificado</option>
                        <option value="compare_all" {% if form.method.value == 'compare_all' %}selected{% endif %}>Comparar Todos los Métodos</option>
                    </select>
                </div>

                <div class="alert alert-info newton-method" role="alert">
                  No es necesario ingresar la derivada de la función f(x) para el método de Newton. Ya se calculará automáticamente.
                </div>

                <div class="alert alert-info newton-modificado-method" role="alert">
                  No es necesario ingresar las derivadas de la función f(x) para el método modificado de Newton. Ya se calcularán automáticamente.
                </div>

                <div class="alert alert-info comparison-alert" role="alert">
                  Por favor, asegúrate de llenar <strong>todos</strong> los campos (f(x), g(x), Xi/X0 y Xs/X1) para una comparación completa.
                  <br>
                  En caso de <strong>no querer evaluar el método Punto Fijo</strong>, puedes dejar el campo g(x) vacío.
                </div>

                <div class="mb-3 parameter-field" data-method="biseccion regla_falsa newton secante newton_modificado punto_fijo compare_all">
                     <label for="id_x0_xi" class="form-label" id="label_x0_xi">Xi / X0:</label>
                     <input type="number" step="any" name="x0_xi" class="form-control" id="id_x0_xi" value="{{ form.x0_xi.value|default_if_none:'' }}">
                </div>

                <div class="mb-3 parameter-field" data-method="biseccion regla_falsa secante compare_all">
                     <label for="id_xs_x1" class="form-label" id="label_xs_x1">Xs / X1:</label>
                     <input type="number" step="any" name="xs_x1" class="form-control" id="id_xs_x1" value="{{ form.xs_x1.value|default_if_none:'' }}">
                </div>
                
                <div class="mb-3">
                     <label for="id_tolerance" class="form-label">Tolerancia:</label>
                     <input type="number" step="any" name="tolerance" class="form-control" id="id_tolerance" required value="{{ form.tolerance.value|default_if_none:'0.00001' }}">
                </div>

                <div class="mb-3">
                     <label for="id_n_iterations" class="form-label">Máx. Iteraciones:</label>
                     <input type="number" name="n_iterations" class="form-control" id="id_n_iterations" required value="{{ form.n_iterations.value|default_if_none:'100' }}">
                </div>

                <button type="submit" class="btn btn-primary" id="calculateButton"><i class="bi bi-calculator"></i> Calcular</button>
                <button type="submit" formaction="{% url 'chapterOne:compare_methods' %}" class="btn btn-success ms-2" id="compareButton">
                    <i class="bi bi-bar-chart-steps"></i> Comparar Todos
                </button>
            </form>
        </div>
        <div class="col-md-7">
            <h2>Resultados: </h2>
            {% if message %}
                <div class="alert {% if 'raíz' in message or 'aprox.' in message %}alert-success{% else %}alert-warning{% endif %}" role="alert">
                    <strong> {{ message }}</strong>
                </div>
            {% endif %}

            {% if results and form.method.value == 'biseccion' %}
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>$$Iteración(i)$$</th>
                                <th>$$a$$</th>
                                <th>$$x_m$$</th>
                                <th>$$b$$</th>
                                <th>$$f(x_m)$$</th>
                                <th>$$Error$$</th>
                            </tr>
                        </thead>
                        <tbody>
                          {% for row in results %}
                          <tr>
                              <td>$${{ row.Iteración }}$$</td>
                              <td>$${{ row.xi|floatformat:10|default:"---" }}$$</td>
                              <td>$${{ row.xm|floatformat:10|default:"---" }}$$</td>
                              <td>$${{ row.xs|floatformat:10|default:"---" }}$$</td>
                              <td>$${{ row.f_xm|floatformat:"2e"|default:"---" }}$$</td> 
                              <td>$${{ row.Error|floatformat:"2e"|default:"---" }}$$</td> 
                          </tr>
                          {% endfor %}
                      </tbody>
                    </table>
                </div>

            {% elif results and form.method.value == 'regla_falsa' %}
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>$$Iteración(i)$$</th>
                                <th>$$a$$</th>
                                <th>$$x_m$$</th>
                                <th>$$b$$</th>
                                <th>$$f(x_m)$$</th>
                                <th>$$Error$$</th>
                            </tr>
                        </thead>
                        <tbody>
                          {% for row in results %}
                          <tr>
                              <td>$${{ row.Iteración }}$$</td>
                              <td>$${{ row.xi|floatformat:10|default:"---" }}$$</td>
                              <td>$${{ row.xm|floatformat:10|default:"---" }}$$</td>
                              <td>$${{ row.xs|floatformat:10|default:"---" }}$$</td>
                              <td>$${{ row.f_xm|floatformat:"2e"|default:"---" }}$$</td> 
                              <td>$${{ row.Error|floatformat:"2e"|default:"---" }}$$</td> 
                          </tr>
                          {% endfor %}
                      </tbody>
                    </table>
                </div>


            {% elif results and form.method.value == 'punto_fijo' %}
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>$$Iteración(i)$$</th>
                                <th>$$x_i$$</th>
                                <th>$$g(x_i)$$</th>
                                <th>$$f(x_i)$$</th>
                                <th>$$Error$$</th>
                            </tr>
                        </thead>
                        <tbody>
                          {% for row in results %}
                        <tr>
                            <td>$${{ row.Iteración }}$$</td>
                            <td>$${{ row.xi|floatformat:10|default:"---" }}$$</td>
                            <td>$${{ row.xm|floatformat:10|default:"---" }}$$</td>
                            <td>$${{ row.f_xm|floatformat:"2e"|default:"---" }}$$</td>
                            <td>$${{ row.Error|floatformat:"2e"|default:"---" }}$$</td>
                        </tr>
                          {% endfor %}
                      </tbody>
                    </table>
                </div>

            {% elif results and form.method.value == 'newton' %}
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>$$Iteración(i)$$</th>
                                <th>$$x_i$$</th>
                                <th>$$f(x_i)$$</th>
                                <th>$$Error$$</th>
                            </tr>
                        </thead>
                        <tbody>
                          {% for row in results %}
                        <tr>
                            <td>$${{ row.Iteración }}$$</td>
                            <td>$${{ row.xi|floatformat:10|default:"---" }}$$</td>
                            <td>$${{ row.f_xm|floatformat:"2e"|default:"---" }}$$</td>
                            <td>$${{ row.Error|floatformat:"2e"|default:"---" }}$$</td>
                        </tr>
                          {% endfor %}
                      </tbody>
                    </table>
                </div>


            {% elif results and form.method.value == 'secante' %}
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>$$Iteración(i)$$</th>
                                <th>$$x_i$$</th>
                                <th>$$f(x_i)$$</th>
                                <th>$$Error$$</th>
                            </tr>
                        </thead>
                        <tbody>
                          {% for row in results %}
                        <tr>
                            <td>$${{ row.Iteración }}$$</td>
                            <td>$${{ row.xi|floatformat:10|default:"---" }}$$</td>
                            <td>$${{ row.f_xm|floatformat:"2e"|default:"---" }}$$</td>
                            <td>$${{ row.Error|floatformat:"2e"|default:"---" }}$$</td>
                        </tr>
                          {% endfor %}
                      </tbody>
                    </table>
                </div>

            {% elif results and form.method.value == 'newton_modificado' %}
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>$$Iteración(i)$$</th>
                                <th>$$x_i$$</th>
                                <th>$$f(x_i)$$</th>
                                <th>$$Error$$</th>
                            </tr>
                        </thead>
                        <tbody>
                          {% for row in results %}
                        <tr>
                            <td>$${{ row.Iteración }}$$</td>
                            <td>$${{ row.xi|floatformat:"3e"|default:"---" }}$$</td>
                            <td>$${{ row.f_xm|floatformat:"2e"|default:"---" }}$$</td>
                            <td>$${{ row.Error|floatformat:"2e"|default:"---" }}$$</td>
                        </tr>
                          {% endfor %}
                      </tbody>
                    </table>
                </div>
            {% else %}



                <p class="text-muted">Los resultados se mostrarán aquí.</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel">Guía de Uso y Sintaxis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4>Consideraciones Generales</h4>
                <ul>
                    <li>Las funciones deben ser continuas y, para algunos métodos (Newton), diferenciables. <strong>Verifícalo visualmente ingresando la función y presionando en el botón "Graficar".</strong></li>
                    <li>Asegúrate de que la función tenga una raíz en el intervalo o cerca del punto inicial.</li>
                    <li>El valor inicial (X0, Xi) es crucial para la convergencia, especialmente en métodos abiertos.</li>
                    <li>La tolerancia debe ser un valor positivo pequeño (ej. 1e-7).</li>
                    <li>El número máximo de iteraciones debe ser un entero positivo.</li>
                </ul>

                <h4>Consideraciones Específicas (Métodos Cerrados)</h4>
                 <ul>
                    <li><strong>Bisección y Regla Falsa:</strong> La función debe tener signos diferentes en los extremos del intervalo (f(a) * f(b) < 0).</li>
                    <li>El valor de 'a' (Xi) debe ser menor que 'b' (Xs).</li>
                    <li>La función debe ser continua en el intervalo [a, b].</li>
                </ul>
                <hr>
                <h2>¿No sabes cómo ingresar funciones?</h2>
                <p>Usa la sintaxis de Python y `numpy`/`sympy`. Aquí tienes una guía:</p>
                <table class="table table-bordered table-striped table-sm">
                    <thead><tr><th>Caracter o Función</th><th>Manera de ingresarlo (ejemplos)</th></tr></thead>
                    <tbody>
                        <tr><td>Seno, Coseno, Tangente</td><td><code>sin(x)</code>, <code>cos(x)</code>, <code>tan(x)</code></td></tr>
                        <tr><td>Cosecante, Secante, Cotangente</td><td><code>1/sin(x)</code>, <code>1/cos(x)</code>, <code>1/tan(x)</code></td></tr>
                        <tr><td>Arcoseno, Arcocoseno, Arcotangente</td><td><code>asin(x)</code>, <code>acos(x)</code>, <code>atan(x)</code></td></tr>
                        <tr><td>Funciones hiperbólicas</td><td><code>sinh(x)</code>, <code>cosh(x)</code>, <code>tanh(x)</code></td></tr>
                        <tr><td>Funciones hiperbólicas inversas</td><td><code>asinh(x)</code>, <code>acosh(x)</code>, <code>atanh(x)</code></td></tr>
                        <tr><td>Número e, Pi (π), Exponencial</td><td><code>exp(1)</code>, <code>pi</code>, <code>exp(x)</code></td></tr>
                        <tr><td>Logaritmo Natural, Logaritmo base 10</td><td><code>log(x)</code>, <code>log10(x)</code></td></tr>
                        <tr><td>Logaritmo base N</td><td><code>log(x, N)</code> (Ej: <code>log(x, 2)</code>)</td></tr>
                        <tr><td>Raíz cuadrada, Potencia N, Raíz N</td><td><code>sqrt(x)</code>, <code>x**N</code>, <code>x**(1/N)</code></td></tr>
                        <tr><td>Valor absoluto</td><td><code>abs(x)</code></td></tr>
                        <tr><td>Multiplicación implícita</td><td><strong>¡Importante!</strong> Usa <code>*</code>. Ej: <code>3*x</code>.</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}
    <script>
    // Script para campos dinámicos del método
        document.getElementById('id_method').addEventListener('change', function() {
            const selectedMethod = this.value;
            const allFields = document.querySelectorAll('.parameter-field');
            const label_x0_xi = document.getElementById('label_x0_xi');
            const label_xs_x1 = document.getElementById('label_xs_x1');
            const comparisonAlert = document.querySelector('.comparison-alert');
            const newtonMethod = document.querySelector('.newton-method');
            const newtonModificadoMethod = document.querySelector('.newton-modificado-method');

            comparisonAlert.style.display = (selectedMethod === 'compare_all') ? 'block' : 'none';
            newtonMethod.style.display = (selectedMethod === 'newton') ? 'block' : 'none';
            newtonModificadoMethod.style.display = (selectedMethod === 'newton_modificado') ? 'block' : 'none';

            allFields.forEach(field => {
                const methods = field.getAttribute('data-method').split(' ');
                const input = field.querySelector('input');

                if (methods.includes(selectedMethod)) {
                    field.style.display = 'block';
                    if (input && selectedMethod !== 'compare_all') {
                        input.required = (selectedMethod !== 'punto_fijo' || input.id === 'id_x0_xi' || input.id === 'id_function_g');
                    } else if (input) {
                        input.required = false; 
                    }
                } else {
                    field.style.display = 'none';
                    if (input) { input.required = false; }
                }
            });

            // Ajustar etiquetas
            if (selectedMethod === 'secante') { label_x0_xi.textContent = 'Valor inicial X0:'; label_xs_x1.textContent = 'Valor inicial X1:'; } 
            else if (selectedMethod === 'punto_fijo') { label_x0_xi.textContent = 'Valor inicial X0:'; } 
            else if (selectedMethod === 'newton') { label_x0_xi.textContent = 'Valor inicial X0:'; }
            else if (selectedMethod === 'newton_modificado') { label_x0_xi.textContent = 'Valor inicial X0:'; }
            else if (selectedMethod === 'compare_all') { label_x0_xi.textContent = 'Xi / X0:'; label_xs_x1.textContent = 'Xs / X1:'; } 
            else { label_x0_xi.textContent = 'Intervalo inferior (a):'; label_xs_x1.textContent = 'Intervalo superior (b):'; }
        });

        // --- SCRIPT PARA BOTONES DE GRÁFICO ---
        const setupGraphButton = (inputId, buttonId) => {
            const functionInput = document.getElementById(inputId);
            const graphButton = document.getElementById(buttonId);
            const graphUrl = "{% url 'chapterOne:graph_function' %}"; 

            if (!functionInput || !graphButton) return; // Salir si no existen

            functionInput.addEventListener('input', function() {
                graphButton.style.display = this.value.trim() ? 'inline-block' : 'none';
            });

            graphButton.addEventListener('click', function() {
                const functionString = functionInput.value.trim();
                if (functionString) {
                    const encodedFunction = encodeURIComponent(functionString);
                    const finalUrl = `${graphUrl}?function=${encodedFunction}`;
                    window.open(finalUrl, '_blank');
                } else {
                    alert("Por favor, ingresa una función para graficar.");
                }
            });
            functionInput.dispatchEvent(new Event('input')); // Llamar al cargar
        };

        setupGraphButton('id_function_f', 'graphButton');
        setupGraphButton('id_function_g', 'graphButton2');
        // --- FIN SCRIPT GRÁFICO ---

        // Disparar evento change al cargar
        document.getElementById('id_method').dispatchEvent(new Event('change'));

    </script>
{% endblock %}