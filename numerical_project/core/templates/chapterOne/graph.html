{% extends "core/base_template.html" %}

{% block title %}Gráfico de {{ function_string|default:"Función" }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        try {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\(", right: "\\)", display: false},
                    {left: "\\[", right: "\\]", display: true}
                ],
                throwOnError: false // Para no detener todo si hay un error LaTeX
            });
        } catch (e) {
            console.error("Error al renderizar KaTeX:", e);
        }
    });
</script>
<style>
    #funcion{
        font-size: 1.2em;
        padding: -20px;
    }
    .katex-display>.katex>.katex-html {
    margin-top:-0.5em;
    display: flex;
    justify-content: start;
    position: relative;
    color: #0dcaf0;

}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Gráfico de la Función</h2>
    <p id="funcion" >Función: <span class="katex-align-left">$$ {{ function_string|default:"No especificado" }} $$</span></p>

    <hr>

    {% if error %}
        <div class="alert alert-danger">
            <strong>Error:</strong> {{ error }}
        </div>
    {% else %}
        <div id="echartDiv" style="width: 100%; height: 500px;"></div>
        <p class="text-muted mt-2">Puedes hacer zoom, moverte y ver valores en el gráfico interactivo.</p>
    {% endif %} 

    <a href="javascript:window.close();" class="btn btn-secondary mt-3">Cerrar Pestaña</a>
</div>
{% endblock %}

{% block extra_scripts %}
    {% if plot_data %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const plotData = JSON.parse('{{ plot_data|safe }}');
                const chartDom = document.getElementById('echartDiv');
                const myChart = echarts.init(chartDom);

                console.log("Rango X:", Math.min(...plotData.x), "a", Math.max(...plotData.x));

                const chartData = plotData.x.map((xVal, index) => {
                    return [xVal, plotData.y[index]];
                });

                

                const option = {
                    title: {
                        text: 'Gráfico de F(x)', // Título general para el gráfico
                        left: 'left', // Alinear a la izquierda
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' }
                    },
                    legend: { 
                        data: ['F(x)'],
                    },
                    grid: {
                        left: '8%',  // Espacio para etiquetas del eje Y
                        right: '8%', // Espacio para leyenda o borde
                        bottom: '10%',// Espacio para etiquetas del eje X y dataZoom
                        containLabel: true // Asegura que las etiquetas de los ejes no se corten
                    },
                    xAxis: {
                        type: 'value',
                        name: 'x',
                        nameLocation: 'middle',
                        nameGap: 30,
                        axisLabel: { formatter: '{value}' },
                        splitLine: { show: true, lineStyle: { type: 'dashed', color: '#ccc'} },
                        axisPointer: { label: { formatter: 'x = {value}' } }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'f(x)',
                        nameLocation: 'middle',
                        nameGap: 50, // Aumentar si el nombre del eje se corta
                        axisLabel: { formatter: '{value}' },
                        splitLine: { show: true, lineStyle: { type: 'dashed', color: '#ccc'} },
                        axisPointer: { label: { formatter: 'y = {value}' } }
                    },
                    dataZoom: [ 
                        {
                            type: 'inside',      // Rueda y arrastre para X
                            xAxisIndex: 0,
                            startValue: -10,
                            endValue: 10,         
                            filterMode: 'none'   // Permite moverse fuera
                        },
                        { 
                            type: 'inside',      // Rueda y arrastre para Y
                            yAxisIndex: 0,
                            startValue: -10,
                            endValue: 10,   
                            filterMode: 'none'   // Permite moverse fuera

                        }
                    ],
                    series: [] // Inicializar array de series vacío
                };

                // Añadir serie de línea interpolada si hay datos
                if (chartData.length > 0) {
                    option.series.push({
                        name: 'F(x)',
                        type: 'line',
                        smooth: true,
                        showSymbol: false,
                        data: chartData,
                        itemStyle: { color: '#0dcaf0', width: 2 },
                    });
                }

                
                if (option.series.length === 0) {
                    console.warn("No hay datos para graficar ninguna serie.");
                    chartDom.innerHTML = '<div class="alert alert-warning" role="alert">No hay datos disponibles para mostrar en el gráfico.</div>';
                    return; 
                }

                myChart.setOption(option);
                window.addEventListener('resize', function() { // Agregado 'function'
                    myChart.resize();
                });

            } catch (e) {
                console.error("Error al renderizar el gráfico con ECharts:", e);
                const chartDiv = document.getElementById('echartDiv');
                if (chartDiv) {
                     chartDiv.innerHTML = '<div class="alert alert-danger">Ocurrió un error al intentar dibujar el gráfico. Revise la consola (F12).</div>';
                }
            }
        });
    </script>
    {% endif %}
{% endblock %}