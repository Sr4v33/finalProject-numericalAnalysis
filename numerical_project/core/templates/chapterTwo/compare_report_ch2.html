{% extends "core/base_template.html" %}
{% load static %}

{% block title %}Comparación Métodos - Cap 2{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        try {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\(", right: "\\)", display: false},
                    {left: "\\[", right: "\\]", display: true}
                ],
                throwOnError: false // Para no detener todo si hay un error LaTeX
            });
        } catch (e) {
            console.error("Error al renderizar KaTeX:", e);
        }
    });
</script>
{% endblock %}


{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Informe Comparación - Sistemas de Ecuaciones Lineales</h1>
        <a href="{% url 'chapterTwo:chapter_two_main' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left-circle"></i> Volver al Formulario
        </a>
    </div>
    <hr>

    {% if global_error %}
        <div class="alert alert-danger">{{ global_error }}</div>
    {% elif all_method_outputs %}
        <h2>Parámetros de Entrada</h2>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Matriz A:</strong> <code>{{ input_data.A_str }}</code></p>
                <p><strong>Vector b:</strong> <code>{{ input_data.b_str }}</code></p>
                <p><strong>Vector x0:</strong> <code>{{ input_data.x0_str }}</code></p>
            </div>
            <div class="col-md-6">
                <p><strong>Tolerancia:</strong> {{ input_data.tol }}</p>
                <p><strong>Iteraciones Máx:</strong> {{ input_data.niter }}</p>
                <p><strong>Omega (SOR):</strong> {{ input_data.omega|default:"N/A" }}</p>
            </div>
        </div>
        <hr>

        <h2>Resultados Generales</h2>
        {% if best_method %}
            <div class="alert alert-success">
                <strong>Mejor Método Identificado:</strong> {{ best_method }} 
                (convergió en {{ min_iter }} iteraciones).
            </div>
        {% else %}
            <div class="alert alert-warning">
                Ninguno de los métodos pudo determinarse como el mejor con los criterios aplicados.
            </div>
        {% endif %}

        <h3 class="mt-4">Tabla Resumen de Resultados</h3>
        <div class="table-responsive mb-4">
            <table class="table table-sm table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>$$Método$$</th>
                        <th>$$Iteraciones$$</th>
                        <th>$$Solución Aproximada (x)$$</th>
                        <th>$$Error Final (Norma)$$</th>
                    </tr>
                </thead>
                <tbody>
                    {% for name, data_tuple in all_method_outputs.items %}
                    {% with results=data_tuple.0 message=data_tuple.1 iterations=data_tuple.4 %}
                    {% with last_iter_row=results|last %} {# <--- ASIGNAR A VARIABLE #}
                    <tr {% if name == best_method %}class="best-method-summary-row"{% endif %}>
                        <td><strong>$$ {{ name }} $$</strong></td>
                        <td>$$ {{ iterations|default:"N/A" }} $$</td>
                        <td>
                            {% if results and last_iter_row and last_iter_row.x_vector %} {# <--- USAR VARIABLE #}
                                $$ \begin{pmatrix}
                                {% for val in last_iter_row.x_vector %} {# <--- USAR VARIABLE #}
                                    {{ val|floatformat:6 }} \\
                                {% endfor %}
                                \end{pmatrix} $$
                            {% else %}
                               $$ --- $$
                            {% endif %}
                        </td>
                        <td>
                            {% if results and last_iter_row and last_iter_row.Error is not None and last_iter_row.Error == last_iter_row.Error %} {# <--- USAR VARIABLE #}
                                $${{ last_iter_row.Error|floatformat:"2e" }}$$
                            {% else %}
                               $$ --- $$
                            {% endif %}
                        </td>
                    </tr>
                    {% endwith %} 
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="my-4">
             <a href="{% url 'chapterTwo:download_pdf_report_ch2' %}" class="btn btn-danger" target="_blank">
                <i class="bi bi-file-pdf-fill"></i> Descargar Informe en PDF
            </a>
        </div>
        <hr>

        <h2>Resultados por Método</h2>
        {% for name, data_tuple in all_method_outputs.items %}
            {% with results=data_tuple.0 message=data_tuple.1 spectral_radius=data_tuple.2 convergence_info=data_tuple.3 iterations=data_tuple.4 %}
            <div class="card mb-4 {% if name == best_method %}border-success{% endif %}">
                <div class="card-header {% if name == best_method %}bg-success text-white{% endif %}">
                    <h3>{{ name }}</h3>
                </div>
                <div class="card-body">
                    <p><strong>Mensaje Final:</strong> <span class="{% if 'Convergió' in message %}text-success{% else %}text-danger{% endif %}">{{ message }}</span></p>
                    <p><strong>Radio Espectral ρ(T):</strong> 
                        {% if spectral_radius == "inf" or spectral_radius > 10000 %} Infinito/Muy Grande {% else %} {{ spectral_radius|floatformat:7 }} {% endif %}
                    </p>
                    <p><strong>Convergencia Teórica:</strong> {{ convergence_info }}</p>
                    <p><strong>Iteraciones Realizadas:</strong> {{ iterations }}</p>
                    
                    {% if results %}
                        <h5>Tabla de Iteraciones (Primeras 5 y Última):</h5>
                        <div class="table-responsive table-responsive-ch2">
                            <table class="table table-sm table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>$$ Iteración $$</th>
                                    <th>$$ x $$</th> <th>$$ Error $$</th>
                                </tr>
                            </thead>
                            <tbody>

                                {% for row in results|slice:":5" %}
                                <tr>
                                    <td class="text-center">$$ {{ row.Iteración }} $$</td>

                                    <td class="text-center">
                                        {% if row.x_vector %}
                                            $$
                                            \begin{pmatrix}
                                            {% for val in row.x_vector %}
                                                {{ val|floatformat:6 }} \\
                                            {% endfor %}
                                            \end{pmatrix}
                                            $$
                                        {% else %}
                                        $$    --- $$
                                        {% endif %}
                                    </td>

                                    <td>
                                        {% if row.Error is not None and row.Error == row.Error %}
                                            $$ {{ row.Error|floatformat:"2e" }} $$
                                        {% else %}
                                            $$ --- $$
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}

                                {# Muestra '...' si hay MÁS de 6 filas (5 primeras + 1 última + al menos una en medio) #}
                                {% if results|length > 6 %}
                                    <tr><td colspan="3" class="text-center">...</td></tr>
                                {% endif %}

                                {# Muestra la última fila SI hay MÁS de 5 filas (para no repetirla si ya se mostró) #}
                                {% if results|length > 5 %}
                                    {% with last_row=results|last %}
                                    <tr>
                                        <td>$$ {{ last_row.Iteración }} $$</td>

                                        <td class="text-center">
                                            {% if last_row.x_vector %}
                                                $$
                                                \begin{pmatrix}
                                                {% for val in last_row.x_vector %}
                                                    {{ val|floatformat:6 }} \\
                                                {% endfor %}
                                                \end{pmatrix}
                                                $$
                                            {% else %}
                                               $$ --- $$
                                            {% endif %}
                                        </td>

                                        <td>
                                            {% if last_row.Error is not None and last_row.Error == last_row.Error %}
                                                $$ {{ last_row.Error|floatformat:"2e" }} $$
                                            {% else %}
                                               $$ --- $$
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endwith %}
                                {% endif %}
                            </tbody>
                        </table>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endwith %}
        {% endfor %}
    {% elif form_errors %}
         <div class="alert alert-danger">
            <p><strong>Errores en el formulario:</strong></p>
            <ul>
                {% for field, errors in form_errors.items %}
                    <li>{{ field }}: {{ errors|join:", " }}</li>
                {% endfor %}
            </ul>
            <p>Por favor, <a href="{% url 'chapterTwo:chapter_two_main' %}">vuelve atrás</a> y corrige los datos.</p>
        </div>
    {% else %}
        <p>No se han procesado datos. <a href="{% url 'chapterTwo:chapter_two_main' %}">Intenta de nuevo</a>.</p>
    {% endif %}
</div>
{% endblock %}